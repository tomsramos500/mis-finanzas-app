<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Finanzas</title>
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/png" href="img/logo.png">
    
    <link rel="apple-touch-icon" href="img/logo.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="js/chart.min.js"></script>

    <style>
        /* Paletas de Temas de Color */
        
        /* Tema 1: Oscuro (Default) */
        :root {
            --color-fondo: #1A1D2D; 
            --color-fondo-container: rgba(44, 47, 72, 0.85); /* Fondo "Glass" */
            --color-fondo-container-solido: #2C2F48;
            --color-fondo-elemento: var(--color-fondo); /* Fondo de cards */
            --color-primario: #3DDC84; /* Verde logo */
            --color-primario-texto: #1A1D2D;
            --color-secundario: #00C4FF; /* Azul logo */
            --color-secundario-texto: #1A1D2D;
            --color-texto-principal: #FFFFFF;
            --color-texto-secundario: #E0E0E0;
            --color-texto-placeholder: #9a9a9a;
            --color-borde: #4A4D64;
            --color-input: #3B3F5C;
            --color-gasto: #dc3545;
            --color-tarjeta: #ffc107;
            --color-ahorro: #17a2b8;
            --color-otro: #6c757d;
            --color-scheme-input-date: dark;
        }
        
        /* Tema 2: Claro */
        body.theme-light {
            --color-fondo: #F4F7F6; 
            --color-fondo-container: rgba(255, 255, 255, 0.85); /* Fondo "Glass" */
            --color-fondo-container-solido: #FFFFFF;
            --color-fondo-elemento: #FFFFFF; /* Fondo de cards */
            --color-primario: #3DDC84; /* Verde logo */
            --color-primario-texto: #1A1D2D;
            --color-secundario: #00C4FF; /* Azul logo */
            --color-secundario-texto: #1A1D2D;
            --color-texto-principal: #1A1D2D;
            --color-texto-secundario: #5A5A5A;
            --color-texto-placeholder: #AAAAAA;
            --color-borde: #E0E0E0;
            --color-input: #F0F0F0;
            --color-gasto: #dc3545;
            --color-tarjeta: #ffc107;
            --color-ahorro: #17a2b8;
            --color-otro: #6c757d;
            --color-scheme-input-date: light;
        }
        
        /* Tema 3: Rosa */
        body.theme-pink {
            --color-fondo: #FFF5F7; 
            --color-fondo-container: rgba(255, 255, 255, 0.85); /* Fondo "Glass" */
            --color-fondo-container-solido: #FFFFFF;
            --color-fondo-elemento: #FFFFFF;
            --color-primario: #D6336C; /* Rosa Fuerte */
            --color-primario-texto: #FFFFFF;
            --color-secundario: #FF79A8; /* Rosa Claro */
            --color-secundario-texto: #3D0015;
            --color-texto-principal: #3D0015;
            --color-texto-secundario: #5E273A;
            --color-texto-placeholder: #AAAAAA;
            --color-borde: #FFD6E3;
            --color-input: #FFF0F3;
            --color-gasto: #dc3545;
            --color-tarjeta: #ffc107;
            --color-ahorro: #17a2b8;
            --color-otro: #6c757d;
            --color-scheme-input-date: light;
        }
        
        /* Tema 4: Celeste */
        body.theme-blue {
            --color-fondo: #F0F8FF; 
            --color-fondo-container: rgba(255, 255, 255, 0.85); /* Fondo "Glass" */
            --color-fondo-container-solido: #FFFFFF;
            --color-fondo-elemento: #FFFFFF;
            --color-primario: #007BFF; /* Azul Fuerte */
            --color-primario-texto: #FFFFFF;
            --color-secundario: #5BC0DE; /* Azul Info */
            --color-secundario-texto: #002A52;
            --color-texto-principal: #002A52;
            --color-texto-secundario: #2A4B69;
            --color-texto-placeholder: #AAAAAA;
            --color-borde: #D6EFFF;
            --color-input: #E6F3FF;
            --color-gasto: #dc3545;
            --color-tarjeta: #ffc107;
            --color-ahorro: #17a2b8;
            --color-otro: #6c757d;
            --color-scheme-input-date: light;
        }

        /* --- Estilos Generales --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-fondo); 
            color: var(--color-texto-secundario); 
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            transition: background-color 0.3s ease;
        }
        .container {
            width: 100%;
            max-width: 800px;
            
            /* Efecto Glassmorphism */
            background: var(--color-fondo-container);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); 
            border: 1px solid var(--color-borde); 
            
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #seccion-app { padding: 30px; }

        /* --- Estilos para el logo en el header --- */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            gap: 15px; 
            border-bottom: 2px solid var(--color-borde); 
            padding-bottom: 10px;
        }
        .app-header-logo { 
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .app-logo {
            width: 48px; 
            height: 48px;
        }
        .app-header h1 {
            border-bottom: none;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }

        #btn-menu {
            background: none;
            border: none;
            color: var(--color-texto-principal);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 10px;
            transition: color 0.3s ease;
        }

        h1, h2 {
            color: var(--color-texto-principal); 
            transition: color 0.3s ease;
        }
        h2 {
            border-bottom: 2px solid var(--color-borde); 
            padding-bottom: 10px;
            transition: border-color 0.3s ease;
        }

        /* --- Selector de Mes --- */
        .selector-mes {
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: 500;
        }
        .selector-mes label { margin-right: 10px; }
        .selector-mes select {
            padding: 8px;
            font-size: 1em;
            border: 1px solid var(--color-borde); 
            border-radius: 4px;
            background-color: var(--color-input); 
            color: var(--color-texto-principal); 
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- Formulario de Ingreso --- */
        .formulario {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .formulario input, .formulario select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-borde); 
            border-radius: 4px;
            box-sizing: border-box; 
            background-color: var(--color-input); 
            color: var(--color-texto-principal); 
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .formulario input::placeholder {
            color: var(--color-texto-placeholder);
        }
        .formulario input[type="date"] {
            color-scheme: var(--color-scheme-input-date);
        }

        .formulario .span-2 { grid-column: span 2; }
        .formulario button {
            grid-column: span 2;
            padding: 12px;
            background-color: var(--color-primario); 
            color: var(--color-primario-texto); 
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .formulario button:hover {
            filter: brightness(0.9);
        }
        
        .formulario button.btn-secundario {
            background-color: var(--color-secundario);
            color: var(--color-secundario-texto);
        }
        
        .formulario button.btn-peligro {
            background-color: var(--color-gasto);
            color: var(--color-texto-principal);
        }
        .formulario button.btn-peligro:hover {
             filter: brightness(0.9);
        }


        /* --- Toggle de Vistas --- */
        .vista-toggle, .form-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .vista-toggle button, .form-toggle button { 
            flex: 1; 
            padding: 10px; 
            font-size: 14px; 
            font-weight: 500; 
            border: 1px solid var(--color-borde); 
            background-color: var(--color-input); 
            color: var(--color-texto-secundario); 
            cursor: pointer; 
            border-radius: 4px; 
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .vista-toggle button.active, .form-toggle button.active { 
            background-color: var(--color-secundario); 
            color: var(--color-secundario-texto); 
            border-color: var(--color-secundario); 
        }
        .form-toggle {
            margin-bottom: 20px;
        }
        
        /* --- Vistas: Resumen y Gráfico --- */
        .resumen-grid { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px; 
        }
        
        .resumen-card {
            background-color: var(--color-fondo-elemento); 
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--color-borde);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .resumen-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-texto-secundario);
            transition: color 0.3s ease;
        }
        .resumen-card .card-monto {
            font-size: 28px;
            font-weight: bold;
            color: var(--color-texto-principal);
            margin-bottom: 15px;
            transition: color 0.3s ease;
        }
        .resumen-card.full-width {
            grid-column: span 2;
        }
        .resumen-card .card-presupuesto-texto {
            font-size: 14px;
            color: var(--color-texto-secundario);
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        .resumen-card .card-presupuesto-texto .monto-gastado {
            font-weight: bold;
            color: var(--color-texto-principal);
        }
        .resumen-card .card-presupuesto-texto .monto-presupuesto {
            font-weight: bold;
            color: var(--color-primario);
        }
        
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: var(--color-input);
            border-radius: 5px;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--color-secundario);
            border-radius: 5px;
            transition: width 0.3s ease-out, background-color 0.3s ease;
        }
        .progress-bar.over-budget {
            background-color: var(--color-gasto); 
        }

        #card-monto-ingresos { color: var(--color-primario); }
        #card-monto-gastos { color: var(--color-gasto); }
        #card-monto-tarjeta { color: var(--color-tarjeta); }
        #card-monto-ahorro { color: var(--color-ahorro); }
        /* ----- Fin estilos Resumen ----- */

        #grafico-container, #evolucion-mensual-container { 
            padding: 10px; 
            position: relative; 
            height: 300px; 
            margin-bottom: 20px; 
            display: none; /* Ocultos por defecto */
        }
        
        /* !NUEVO! Damos más altura al gráfico de barras horizontal */
        #evolucion-mensual-container {
            height: 600px; /* Más altura para que entren los 31 días */
        }
        
        /* --- Vista: Calendario --- */
        #calendario-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background-color: var(--color-borde); border: 1px solid var(--color-borde); border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .calendario-header { background-color: var(--color-otro); color: white; text-align: center; padding: 8px 0; font-size: 0.9em; font-weight: 600; }
        .calendario-dia { min-height: 80px; background-color: var(--color-fondo-container-solido); padding: 6px; position: relative; transition: background-color 0.3s ease; }
        .calendario-dia.dia-valido { cursor: pointer; }
        .calendario-dia.dia-valido:hover { background-color: var(--color-input); }
        .calendario-dia.otro-mes { background-color: var(--color-fondo); color: #666; }
        
        .dia-numero { 
            font-size: 0.9em; 
            font-weight: 500; 
            color: var(--color-texto-principal);
        }
        
        .dia-marcador-ingreso, .dia-marcador-gasto { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-top: 5px; margin-right: 2px; }
        .dia-marcador-ingreso { background-color: var(--color-primario); }
        .dia-marcador-gasto { background-color: var(--color-gasto); }

        /* --- Historial de Transacciones --- */
        #lista-transacciones { list-style: none; padding: 0; }
        #lista-transacciones li { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--color-borde); transition: border-color 0.3s ease; }
        #lista-transacciones li:nth-child(even) { background-color: rgba(0,0,0,0.1); }
        #lista-transacciones .detalle { flex-grow: 1; display: flex; align-items: center; }
        #lista-transacciones .monto { font-weight: 600; margin-left: 10px; }
        #lista-transacciones .dia-historial { font-weight: 600; color: var(--color-texto-principal); width: 50px; text-align: right; margin-right: 8px; flex-shrink: 0; }
        #lista-transacciones .motivo { color: var(--color-texto-secundario); }
        #lista-transacciones .clasif { font-size: 12px; font-weight: 500; padding: 3px 6px; border-radius: 4px; color: white; margin-left: 8px; margin-right: 8px; }
        
        .clasif-INGRESO { background-color: var(--color-primario); color: var(--color-primario-texto); }
        .clasif-GASTO { background-color: var(--color-gasto); }
        .clasif-TARJETA { background-color: var(--color-tarjeta); color: #333; }
        .clasif-AHORRO { background-color: var(--color-ahorro); }
        .clasif-OTRO { background-color: var(--color-otro); }
        
        .btn-eliminar { background-color: var(--color-gasto); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; padding: 0; margin-left: 15px; flex-shrink: 0; }
        .btn-eliminar:hover { background-color: #c82333; }
        
        #lista-presupuestos-actuales {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        #lista-presupuestos-actuales li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--color-input);
            border-radius: 4px;
            margin-bottom: 8px;
            transition: background-color 0.3s ease;
        }
        .btn-eliminar-presupuesto {
            color: var(--color-gasto);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
        }
        .btn-eliminar-presupuesto:hover {
            text-decoration: underline;
        }
        
        /* --- Estilos del Modal (Pop-up) --- */
        #modal-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 1000; }
        #modal-content { 
            background-color: rgba(44, 47, 72, 0.9); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); 
            
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            width: 90%; 
            max-width: 500px; 
            position: relative; 
            border: 1px solid var(--color-borde);
            
            background-color: var(--color-fondo-container);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #modal-close { position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; }
        #modal-close:hover { color: var(--color-texto-principal); }
        #modal-titulo { margin-top: 0; border-bottom: 1px solid var(--color-borde); padding-bottom: 10px; transition: border-color 0.3s ease; }
        #modal-lista { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        #modal-lista li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-borde); transition: border-color 0.3s ease; }
        #modal-lista .monto-ingreso { color: var(--color-primario); font-weight: 600; }
        #modal-lista .monto-gasto { color: var(--color-gasto); font-weight: 600; }

        /* --- Estilos para Menú Lateral --- */
        #menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1999;
            display: none; 
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100%;
            background-color: var(--color-fondo-container-solido);
            border-right: 1px solid var(--color-borde);
            box-shadow: 4px 0 15px rgba(0,0,0,0.2);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            transform: translateX(-100%); 
            transition: transform 0.3s ease-out, background-color 0.3s ease, border-color 0.3s ease;
            padding: 20px;
            box-sizing: border-box;
        }
        #side-menu.menu-open {
            transform: translateX(0);
        }
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-borde);
            padding-bottom: 15px;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }
        .menu-header span {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--color-texto-principal);
            transition: color 0.3s ease;
        }
        #btn-close-menu {
            background: none;
            border: none;
            color: var(--color-texto-secundario);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
        }
        #side-menu .formulario {
            display: flex;
            flex-direction: column;
        }
        #side-menu h2 {
            border: none;
            padding: 0;
            margin-top: 0;
        }
        
        .menu-button {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--color-input);
            color: var(--color-texto-secundario);
            border: 1px solid var(--color-borde);
            border-radius: 4px;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 10px;
        }
        .menu-button:hover {
            background-color: var(--color-borde);
        }

        .theme-switcher {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .theme-switcher button {
            padding: 10px;
            border-radius: 4px;
            border: 2px solid var(--color-borde);
            background-color: var(--color-input);
            color: var(--color-texto-secundario);
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .theme-switcher button.active-theme {
            border-color: var(--color-secundario);
            color: var(--color-secundario-texto);
            background-color: var(--color-secundario);
        }
        
        /* --- Estilos para Vista 6 Meses --- */
        #seccion-evolucion-6meses {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-fondo);
            z-index: 1001;
            display: none; /* Oculto por defecto */
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            transition: background-color 0.3s ease;
        }
        #seccion-evolucion-6meses .app-header {
            justify-content: space-between; 
        }
        #seccion-evolucion-6meses #btn-volver-app {
            background: none;
            border: none;
            color: var(--color-texto-principal);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 10px;
        }
        #evolucion-6meses-container {
            width: 100%;
            height: calc(100% - 100px); /* Restar espacio para el header */
            position: relative;
            margin-top: 20px;
        }
        
    </style>
</head>
<body class="theme-default"> <div class="container">
        
        <div id="seccion-app">
            
            <div class="app-header">
                <div class="app-header-logo">
                    <img src="img/logo.png" alt="Logo" class="app-logo">
                    <h1>Mis Finanzas</h1>
                </div>
                <button id="btn-menu" title="Menú">☰</button>
            </div>
            
            <div class="selector-mes">
                <label for="select-mes">Ver Mes:</label>
                <select id="select-mes"></select>
            </div>

            <div class="form-toggle vista-toggle">
                <button id="btn-ver-form-transaccion" class="active">Agregar Transacción</button>
                <button id="btn-ver-form-presupuesto">Fijar Presupuesto</button>
            </div>

            <div id="seccion-agregar-transaccion">
                <div class="formulario">
                    <input type="date" id="form-date" class="span-2">
                    <input type="number" id="form-monto" placeholder="Monto (ej: 140000)">
                    <input type="text" id="form-motivo" placeholder="Motivo (ej: Venta rueda)">
                    <select id="form-clasificador" class="span-2"></select>
                    <button id="btn-agregar" class="span-2">Agregar</button>
                </div>
            </div>
            
            <div id="seccion-fijar-presupuesto" style="display: none;">
                <div class="formulario">
                    <select id="form-presupuesto-clasif" class="span-2">
                        </select>
                    <input type="number" id="form-presupuesto-monto" placeholder="Monto presupuestado" class="span-2">
                    <button id="btn-guardar-presupuesto" class="span-2 btn-secundario">Guardar Presupuesto</button>
                </div>
                <ul id="lista-presupuestos-actuales">
                    </ul>
            </div>


            <h2>Resumen del Mes</h2>
            
            <div class="vista-toggle">
                <button id="btn-ver-resumen" class="active">Resumen</button>
                <button id="btn-ver-grafico">Gráfico</button>
                <button id="btn-ver-evolucion-mensual">Actividad Diaria</button> 
                <button id="btn-ver-calendario">Calendario</button>
            </div>
            
            <div class="resumen-grid" id="resumen-totales">
                </div>
            
            <div id="grafico-container"><canvas id="grafico-torta"></canvas></div>
            <div id="evolucion-mensual-container"><canvas id="grafico-evolucion-mensual"></canvas></div> 
            
            <div id="calendario-container" style="display: none;"></div>

            <h2>Historial del Mes</h2>
            <ul id="lista-transacciones"></ul>
        </div>
    </div>
    
    <div id="modal-container">
        <div id="modal-content">
            <span id="modal-close">&times;</span>
            <h3 id="modal-titulo">Detalles del Día</h3>
            <ul id="modal-lista">
            </ul>
        </div>
    </div>
    
    <div id="menu-overlay"></div>
    <nav id="side-menu">
        <div class="menu-header">
            <span>Menú Principal</span>
            <button id="btn-close-menu" title="Cerrar">&times;</button>
        </div>
        
        <button id="btn-ver-evolucion-6meses" class="menu-button">Evolución (6 Meses)</button>
        
        <h2 style="margin-top: 20px;">Temas de Color</h2>
        <div class="theme-switcher">
            <button data-theme="default" id="theme-default">Oscuro</button>
            <button data-theme="light" id="theme-light">Claro</button>
            <button data-theme="pink" id="theme-pink">Rosa</button>
            <button data-theme="blue" id="theme-blue">Celeste</button>
        </div>
        
        <h2 style="margin-top: 30px;">Respaldo de Datos</h2>
        <div class="formulario">
            <button id="btn-exportar" class="span-2 btn-secundario">Exportar Respaldo (Descargar)</button>
            <button id="btn-importar-trigger" class="span-2 btn-peligro">Importar Respaldo (Subir)</button>
            <input type="file" id="input-importar" style="display: none;" accept=".json">
        </div>
        
    </nav>
    
    <div id="seccion-evolucion-6meses">
        <div class="app-header">
            <div class="app-header-logo">
                <h1>Evolución (6 Meses)</h1>
            </div>
            <button id="btn-volver-app" title="Volver">&times;</button>
        </div>
        <div id="evolucion-6meses-container">
            <canvas id="grafico-evolucion-6meses"></canvas>
        </div>
    </div>


    <script>
        
        // =======================================
        //     REGISTRO DEL SERVICE WORKER
        // =======================================
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
              .then(registration => {
                console.log('ServiceWorker registrado con éxito:', registration.scope);
              })
              .catch(error => {
                console.log('Error al registrar ServiceWorker:', error);
              });
          });
        }
        // =======================================


        // --- ESTADO DE LA APLICACIÓN ---
        let transacciones = {}; 
        let presupuestos = {}; 
        let clasificadores = new Set(['INGRESO', 'GASTO', 'TARJETA', 'AHORRO']);
        let mesSeleccionado = '';
        let vistaActual = 'resumen';
        let vistaFormularioActual = 'transaccion'; 
        let miGraficoDeTorta = null;
        let miGraficoEvolucionDiaria = null; // !MODIFICADO!
        let miGraficoEvolucion6Meses = null; 
        let temaActual = 'default'; 
        
        const COLORES_CLASIF = {
            'GASTO': '#dc3545',
            'TARJETA': '#ffc107',
            'AHORRO': '#17a2b8',
            'OTRO': '#6c757d'
        };
        
        const NOMBRES_MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const DIAS_SEMANA = ['DOM', 'LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB'];

        // --- ELEMENTOS DEL DOM ---
        const selectMes = document.getElementById('select-mes');
        const formDate = document.getElementById('form-date');
        const formMonto = document.getElementById('form-monto');
        const formMotivo = document.getElementById('form-motivo');
        const formClasificador = document.getElementById('form-clasificador');
        const btnAgregar = document.getElementById('btn-agregar');
        const btnVerResumen = document.getElementById('btn-ver-resumen');
        const btnVerGrafico = document.getElementById('btn-ver-grafico');
        const btnVerCalendario = document.getElementById('btn-ver-calendario');
        const resumenTotalesDiv = document.getElementById('resumen-totales');
        const graficoContainer = document.getElementById('grafico-container');
        const graficoCanvas = document.getElementById('grafico-torta');
        const calendarioContainer = document.getElementById('calendario-container');
        const listaTransacciones = document.getElementById('lista-transacciones');
        const modalContainer = document.getElementById('modal-container');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalTitulo = document.getElementById('modal-titulo');
        const modalLista = document.getElementById('modal-lista');
        const formPresupuestoClasif = document.getElementById('form-presupuesto-clasif');
        const formPresupuestoMonto = document.getElementById('form-presupuesto-monto');
        const btnGuardarPresupuesto = document.getElementById('btn-guardar-presupuesto');
        const listaPresupuestosActuales = document.getElementById('lista-presupuestos-actuales');
        const btnVerFormTransaccion = document.getElementById('btn-ver-form-transaccion');
        const btnVerFormPresupuesto = document.getElementById('btn-ver-form-presupuesto');
        const seccionAgregarTransaccion = document.getElementById('seccion-agregar-transaccion');
        const seccionFijarPresupuesto = document.getElementById('seccion-fijar-presupuesto');
        const btnExportar = document.getElementById('btn-exportar');
        const btnImportarTrigger = document.getElementById('btn-importar-trigger');
        const inputImportar = document.getElementById('input-importar');
        const btnMenu = document.getElementById('btn-menu');
        const btnCloseMenu = document.getElementById('btn-close-menu');
        const sideMenu = document.getElementById('side-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        const themeButtons = document.querySelectorAll('.theme-switcher button');
        
        const btnVerEvolucionDiaria = document.getElementById('btn-ver-evolucion-mensual'); 
        const evolucionDiariaContainer = document.getElementById('evolucion-mensual-container'); 
        const evolucionDiariaCanvas = document.getElementById('grafico-evolucion-mensual'); 
        
        const btnVerEvolucion6Meses = document.getElementById('btn-ver-evolucion-6meses');
        const seccionEvolucion6Meses = document.getElementById('seccion-evolucion-6meses');
        const evolucion6MesesCanvas = document.getElementById('grafico-evolucion-6meses');
        const btnVolverApp = document.getElementById('btn-volver-app');


        // --- FUNCIONES DE GUARDADO (LOCALSTORAGE) ---
        function guardarDatosEnLocalStorage() {
            localStorage.setItem('misFinanzas_transacciones', JSON.stringify(transacciones));
            localStorage.setItem('misFinanzas_clasificadores', JSON.stringify(Array.from(clasificadores)));
            localStorage.setItem('misFinanzas_presupuestos', JSON.stringify(presupuestos)); 
            localStorage.setItem('misFinanzas_tema', temaActual); 
            console.log("Datos guardados.");
        }

        function cargarDatosDesdeLocalStorage() {
            const transGuardadas = localStorage.getItem('misFinanzas_transacciones');
            const clasifGuardados = localStorage.getItem('misFinanzas_clasificadores');
            const presupGuardados = localStorage.getItem('misFinanzas_presupuestos'); 
            const temaGuardado = localStorage.getItem('misFinanzas_tema'); 

            transacciones = transGuardadas ? JSON.parse(transGuardadas) : {};
            clasificadores = clasifGuardados ? new Set(JSON.parse(clasifGuardados)) : new Set(['INGRESO', 'GASTO', 'TARJETA', 'AHORRO']);
            presupuestos = presupGuardados ? JSON.parse(presupGuardados) : {};
            temaActual = temaGuardado ? temaGuardado : 'default'; 
            
            console.log("Datos cargados.");
        }

        // --- LÓGICA DE INICIO ---
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatosDesdeLocalStorage(); 
            aplicarTema(temaActual); 
            
            // Listeners de la app
            btnAgregar.addEventListener('click', agregarTransaccion);
            selectMes.addEventListener('change', cambiarMes);
            btnVerResumen.addEventListener('click', () => cambiarVista('resumen'));
            btnVerGrafico.addEventListener('click', () => cambiarVista('grafico'));
            btnVerCalendario.addEventListener('click', () => cambiarVista('calendario'));
            btnVerEvolucionDiaria.addEventListener('click', () => cambiarVista('evolucionDiaria'));
            formClasificador.addEventListener('change', manejarCambioClasificador);
            btnGuardarPresupuesto.addEventListener('click', guardarPresupuesto); 
            
            // Listeners para Toggle de Formularios
            btnVerFormTransaccion.addEventListener('click', () => cambiarVistaFormulario('transaccion'));
            btnVerFormPresupuesto.addEventListener('click', () => cambiarVistaFormulario('presupuesto'));

            // Listeners del Modal
            modalCloseBtn.addEventListener('click', cerrarModal);
            modalContainer.addEventListener('click', (e) => {
                if (e.target === modalContainer) {
                    cerrarModal();
                }
            });
            
            // Listeners para Exportar/Importar
            btnExportar.addEventListener('click', exportarDatos);
            btnImportarTrigger.addEventListener('click', () => inputImportar.click());
            inputImportar.addEventListener('change', importarDatos);
            
            // Listeners para Menú Lateral
            btnMenu.addEventListener('click', abrirMenu);
            btnCloseMenu.addEventListener('click', cerrarMenu);
            menuOverlay.addEventListener('click', cerrarMenu);
            
            // Listeners para Vista 6 Meses
            btnVerEvolucion6Meses.addEventListener('click', mostrarVistaEvolucion6Meses);
            btnVolverApp.addEventListener('click', ocultarVistaEvolucion6Meses);
            
            // Listeners para Temas
            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tema = button.dataset.theme;
                    aplicarTema(tema);
                    cerrarMenu(); 
                });
            });

            // Preparar la app
            popularSelectorDeMes();
            actualizarSelectClasificadores();
            actualizarSelectPresupuesto(); 
            
            mesSeleccionado = selectMes.value;
            formDate.value = new Date().toISOString().split('T')[0];
            actualizarUI();
            cambiarVistaFormulario('transaccion'); 
        });
        
        function manejarCambioClasificador() {
            if (formClasificador.value === '--NUEVO--') {
                const nuevoClasif = prompt("Escribe el nombre de la nueva clasificación:");
                
                if (nuevoClasif && nuevoClasif.trim() !== '') {
                    const clasifFormateado = nuevoClasif.trim().toUpperCase();
                    
                    if (clasificadores.has(clasifFormateado)) {
                        alert("Esa clasificación ya existe."); 
                        formClasificador.value = clasifFormateado; 
                    } else {
                        clasificadores.add(clasifFormateado);
                        guardarDatosEnLocalStorage();
                        actualizarSelectClasificadores(); 
                        actualizarSelectPresupuesto(); 
                        formClasificador.value = clasifFormateado; 
                    }
                } else {
                    formClasificador.value = 'GASTO'; 
                }
            }
        }
        
        // --- FUNCIONES DE MENÚ LATERAL ---
        function abrirMenu() {
            sideMenu.classList.add('menu-open');
            menuOverlay.style.display = 'block';
            setTimeout(() => { 
                menuOverlay.style.opacity = '1';
            }, 10);
        }
        
        function cerrarMenu() {
            sideMenu.classList.remove('menu-open');
            menuOverlay.style.opacity = '0';
            setTimeout(() => { 
                menuOverlay.style.display = 'none';
            }, 300); 
        }

        // --- FUNCIONES VISTA 6 MESES ---
        function mostrarVistaEvolucion6Meses() {
            cerrarMenu();
            document.querySelector('.container').style.display = 'none';
            seccionEvolucion6Meses.style.display = 'block';
            renderizarGraficoEvolucion6Meses();
        }

        function ocultarVistaEvolucion6Meses() {
            seccionEvolucion6Meses.style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            if (miGraficoEvolucion6Meses) {
                miGraficoEvolucion6Meses.destroy();
                miGraficoEvolucion6Meses = null;
            }
        }

        
        // --- FUNCIONES DE TEMAS ---
        function aplicarTema(tema) {
            document.body.classList.remove('theme-light', 'theme-pink', 'theme-blue');
            
            if (tema !== 'default') {
                document.body.classList.add(`theme-${tema}`);
            }
            
            themeButtons.forEach(btn => {
                if (btn.dataset.theme === tema) {
                    btn.classList.add('active-theme');
                } else {
                    btn.classList.remove('active-theme');
                }
            });

            temaActual = tema;
            guardarDatosEnLocalStorage();
            
            // Forzar actualización de gráficos si están visibles
            if (vistaActual === 'grafico') {
                renderizarGrafico();
            } else if (vistaActual === 'evolucionDiaria') {
                renderizarGraficoEvolucionDiaria();
            }
            
            if (seccionEvolucion6Meses.style.display === 'block') {
                renderizarGraficoEvolucion6Meses();
            }
        }

        // --- FUNCIONES DE AYUDA DE COLORES (para gráficos) ---
        function obtenerColoresTema() {
            const bodyStyles = getComputedStyle(document.body);
            return {
                textoPrincipal: bodyStyles.getPropertyValue('--color-texto-principal').trim(),
                textoSecundario: bodyStyles.getPropertyValue('--color-texto-secundario').trim(),
                primario: bodyStyles.getPropertyValue('--color-primario').trim(),
                gasto: bodyStyles.getPropertyValue('--color-gasto').trim(),
                tarjeta: bodyStyles.getPropertyValue('--color-tarjeta').trim(),
                ahorro: bodyStyles.getPropertyValue('--color-ahorro').trim(),
                otro: bodyStyles.getPropertyValue('--color-otro').trim(),
                borde: bodyStyles.getPropertyValue('--color-borde').trim(),
                fondoInput: bodyStyles.getPropertyValue('--color-input').trim()
            };
        }

        function obtenerColorClasificador(clasificador, colores) {
            switch(clasificador) {
                case 'INGRESO': return colores.primario;
                case 'GASTO': return colores.gasto;
                case 'TARJETA': return colores.tarjeta;
                case 'AHORRO': return colores.ahorro;
                default: return COLORES_CLASIF[clasificador] || colores.otro; 
            }
        }


        // --- FUNCIONES PRINCIPALES ---
        function popularSelectorDeMes() {
            const hoy = new Date();
            const anioActual = hoy.getFullYear();
            const mesActual = hoy.getMonth();
            const anioFinal = 2030;
            selectMes.innerHTML = '';
            const mesesGuardados = Object.keys(transacciones);
            const primerAnioGuardado = mesesGuardados.length > 0 ? parseInt(mesesGuardados[0].split('-')[0]) : anioActual;
            const anioInicio = Math.min(primerAnioGuardado, anioActual);
            for (let anio = anioInicio; anio <= anioFinal; anio++) {
                for (let mes = 0; mes < 12; mes++) {
                    const valorMes = `${anio}-${(mes + 1).toString().padStart(2, '0')}`;
                    const textoMes = `${NOMBRES_MESES[mes]} ${anio}`;
                    const option = document.createElement('option');
                    option.value = valorMes;
                    option.textContent = textoMes;
                    if (anio === anioActual && mes === mesActual) {
                        option.selected = true;
                    }
                    selectMes.appendChild(option);
                }
            }
        }
        function cambiarMes() {
            mesSeleccionado = selectMes.value;
            actualizarUI();
        }
        
        function cambiarVista(nuevaVista) {
            vistaActual = nuevaVista;
            actualizarUI(); 
        }
        
        function cambiarVistaFormulario(nuevaVista) {
            vistaFormularioActual = nuevaVista;
            
            seccionAgregarTransaccion.style.display = 'none';
            seccionFijarPresupuesto.style.display = 'none';
            
            btnVerFormTransaccion.classList.remove('active');
            btnVerFormPresupuesto.classList.remove('active');

            if (nuevaVista === 'transaccion') {
                seccionAgregarTransaccion.style.display = 'block';
                btnVerFormTransaccion.classList.add('active');
            } else if (nuevaVista === 'presupuesto') {
                seccionFijarPresupuesto.style.display = 'block';
                btnVerFormPresupuesto.classList.add('active');
            }
        }

        function getDatosMesActual() {
            if (!transacciones[mesSeleccionado]) {
                transacciones[mesSeleccionado] = [];
            }
            return transacciones[mesSeleccionado];
        }

        function agregarTransaccion() {
            const date = formDate.value;
            const monto = parseFloat(formMonto.value);
            const motivo = formMotivo.value;
            let clasificador = formClasificador.value; 

            if (!date) { alert("Por favor, selecciona una fecha."); return; }
            if (isNaN(monto) || monto <= 0 || !motivo) { alert("Por favor, completa el monto y el motivo."); return; }
            
            if (clasificador === '--NUEVO--') {
                alert("Por favor, selecciona una clasificación válida antes de agregar.");
                return;
            }

            const nuevaTransaccion = {
                id: Date.now(), date, monto, motivo, clasificador
            };

            const mesDeLaTransaccion = date.substring(0, 7);
            if (!transacciones[mesDeLaTransaccion]) {
                transacciones[mesDeLaTransaccion] = [];
                popularSelectorDeMes();
            }
            transacciones[mesDeLaTransaccion].push(nuevaTransaccion);
            
            selectMes.value = mesDeLaTransaccion;
            mesSeleccionado = mesDeLaTransaccion;
            
            actualizarUI();
            limpiarFormulario();
            guardarDatosEnLocalStorage(); 
        }
        
        function eliminarTransaccion(idAEliminar) {
            if (!confirm("¿Estás seguro de que quieres eliminar esta transacción?")) return;
            const datosMes = getDatosMesActual();
            const index = datosMes.findIndex(t => t.id === idAEliminar);
            if (index > -1) datosMes.splice(index, 1);
            
            actualizarUI();
            guardarDatosEnLocalStorage(); 
        }
        
        function limpiarFormulario() {
            formDate.value = new Date().toISOString().split('T')[0];
            formMonto.value = '';
            formMotivo.value = '';
            formClasificador.value = 'GASTO';
        }

        function actualizarSelectClasificadores() {
            const valorPrevio = formClasificador.value; 
            
            formClasificador.innerHTML = ''; 
            const clasificadoresOrdenados = Array.from(clasificadores).sort();
            
            for (let c of clasificadoresOrdenados) {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                formClasificador.appendChild(option);
            }
            
            const optionNueva = document.createElement('option');
            optionNueva.value = '--NUEVO--';
            optionNueva.textContent = '...Añadir nueva clasificación...';
            optionNueva.style.fontStyle = 'italic'; 
            optionNueva.style.color = '#555';
            formClasificador.appendChild(optionNueva);
            
            if (valorPrevio && valorPrevio !== '--NUEVO--') {
                formClasificador.value = valorPrevio;
            } else {
                formClasificador.value = clasificadores.has('GASTO') ? 'GASTO' : clasificadoresOrdenados[0]; 
            }
        }
        
        // --- FUNCIONES DE PRESUPUESTO ---
        function actualizarSelectPresupuesto() {
            formPresupuestoClasif.innerHTML = '';
            const clasificadoresOrdenados = Array.from(clasificadores).sort();
            
            const optionDefault = document.createElement('option');
            optionDefault.value = '';
            optionDefault.textContent = 'Selecciona categoría para presupuestar';
            formPresupuestoClasif.appendChild(optionDefault);

            for (let c of clasificadoresOrdenados) {
                if (c === 'INGRESO') continue; 
                
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                formPresupuestoClasif.appendChild(option);
            }
        }

        function guardarPresupuesto() {
            const clasificador = formPresupuestoClasif.value;
            const monto = parseFloat(formPresupuestoMonto.value);

            if (!clasificador) {
                alert("Por favor, selecciona una categoría.");
                return;
            }
            if (isNaN(monto) || monto < 0) {
                 alert("Por favor, ingresa un monto válido.");
                return;
            }

            const key = `${mesSeleccionado}_${clasificador}`;
            if (monto === 0) {
                delete presupuestos[key]; 
            } else {
                presupuestos[key] = monto;
            }
            
            guardarDatosEnLocalStorage();
            actualizarUI(); 
            
            formPresupuestoClasif.value = '';
            formPresupuestoMonto.value = '';
        }
        
        function renderizarListaPresupuestos() {
            listaPresupuestosActuales.innerHTML = '';
            let hayPresupuestos = false;
            
            for (const key in presupuestos) {
                if (key.startsWith(mesSeleccionado)) {
                    hayPresupuestos = true;
                    const clasificador = key.replace(`${mesSeleccionado}_`, '');
                    const monto = presupuestos[key];
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${clasificador}: <strong>$${monto.toLocaleString('es-AR')}</strong></span>
                        <a href="#" class="btn-eliminar-presupuesto" onclick="eliminarPresupuesto('${clasificador}')">Eliminar</a>
                    `;
                    listaPresupuestosActuales.appendChild(li);
                }
            }
            if (!hayPresupuestos) {
                listaPresupuestosActuales.innerHTML = '<li><span style="color: #9a9a9a; font-style: italic;">No hay presupuestos guardados para este mes.</span></li>';
            }
        }
        
        function eliminarPresupuesto(clasificador) {
            if (!confirm(`¿Eliminar el presupuesto para "${clasificador}"?`)) return;
            
            const key = `${mesSeleccionado}_${clasificador}`;
            delete presupuestos[key];
            guardarDatosEnLocalStorage();
            actualizarUI();
        }

        // --- FUNCIONES DE RENDERIZADO ---
        function actualizarUI() {
            renderizarLista();
            renderizarListaPresupuestos(); 
            
            resumenTotalesDiv.style.display = 'none';
            graficoContainer.style.display = 'none';
            evolucionDiariaContainer.style.display = 'none'; 
            calendarioContainer.style.display = 'none';
            btnVerResumen.classList.remove('active');
            btnVerGrafico.classList.remove('active');
            btnVerEvolucionDiaria.classList.remove('active'); 
            btnVerCalendario.classList.remove('active');
            
            if (vistaActual === 'resumen') {
                btnVerResumen.classList.add('active');
                resumenTotalesDiv.style.display = 'grid'; 
                renderizarResumen(); 
            } else if (vistaActual === 'grafico') {
                btnVerGrafico.classList.add('active');
                graficoContainer.style.display = 'block';
                renderizarGrafico();
            } else if (vistaActual === 'evolucionDiaria') { 
                btnVerEvolucionDiaria.classList.add('active');
                evolucionDiariaContainer.style.display = 'block';
                renderizarGraficoEvolucionDiaria();
            } else if (vistaActual === 'calendario') {
                btnVerCalendario.classList.add('active');
                calendarioContainer.style.display = 'grid';
                renderizarCalendario();
            }
            
            cambiarVistaFormulario(vistaFormularioActual);
        }

        function renderizarLista() {
            listaTransacciones.innerHTML = ''; 
            const datosMes = getDatosMesActual();
            const datosOrdenados = [...datosMes].sort((a, b) => new Date(a.date) - new Date(b.date));
            for (let t of datosOrdenados) {
                const li = document.createElement('li');
                let claseColor = `clasif-${t.clasificador}`;
                if (!['INGRESO', 'GASTO', 'TARJETA', 'AHORRO'].includes(t.clasificador)) {
                    claseColor = 'clasif-OTRO';
                }
                const fechaObj = new Date(t.date + 'T12:00:00');
                const dia = fechaObj.getDate().toString().padStart(2, '0');
                const mes = (fechaObj.getMonth() + 1).toString().padStart(2, '0');
                const fechaFormateada = `${dia}/${mes}`;
                li.innerHTML = `
                    <div class="detalle">
                        <span class="dia-historial">${fechaFormateada}</span>
                        <span class="clasif ${claseColor}">${t.clasificador}</span>
                        <span class="motivo">${t.motivo}</span>
                    </div>
                    <span class="monto">$${t.monto.toLocaleString('es-AR')}</span>
                    <button class="btn-eliminar" onclick="eliminarTransaccion(${t.id})" title="Eliminar">✖</button>
                `;
                listaTransacciones.appendChild(li);
            }
        }

        // FUNCIÓN DE RESUMEN REESCRITA PARA USAR "CARDS"
        function renderizarResumen() {
            const datosMes = getDatosMesActual();
            const sumas = {};
            let saldoTotal = 0.0;
            
            for (let c of clasificadores) { sumas[c] = 0; }
            
            for (let t of datosMes) {
                if (!sumas[t.clasificador]) {
                    sumas[t.clasificador] = 0;
                }
                sumas[t.clasificador] += t.monto;
                
                if (t.clasificador === 'INGRESO') {
                    saldoTotal += t.monto;
                } else {
                    saldoTotal -= t.monto;
                }
            }
            
            resumenTotalesDiv.innerHTML = ''; 
            
            // --- Tarjeta 1: Saldo Total (Ocupa todo el ancho) ---
            const cardSaldo = document.createElement('div');
            cardSaldo.className = 'resumen-card full-width';
            cardSaldo.innerHTML = `
                <h3>SALDO DEL MES</h3>
                <div class="card-monto" style="color: ${saldoTotal >= 0 ? 'var(--color-primario)' : 'var(--color-gasto)'};">
                    $${saldoTotal.toLocaleString('es-AR', {minimumFractionDigits: 2})}
                </div>
            `;
            resumenTotalesDiv.appendChild(cardSaldo);

            // --- Tarjeta 2: Ingresos (Mitad de ancho) ---
            if (sumas['INGRESO'] > 0) {
                const cardIngreso = document.createElement('div');
                cardIngreso.className = 'resumen-card';
                cardIngreso.innerHTML = `
                    <h3>INGRESOS</h3>
                    <div class="card-monto" id="card-monto-ingresos">
                        $${sumas['INGRESO'].toLocaleString('es-AR', {minimumFractionDigits: 2})}
                    </div>
                `;
                resumenTotalesDiv.appendChild(cardIngreso);
            }

            // --- Tarjetas de Gastos y Presupuestos (El resto) ---
            for (let clasif in sumas) {
                if (clasif === 'INGRESO' || sumas[clasif] <= 0) continue; 
                
                const gastado = sumas[clasif];
                const keyPresupuesto = `${mesSeleccionado}_${clasif}`;
                const presupuestado = presupuestos[keyPresupuesto] || 0;

                const cardGasto = document.createElement('div');
                cardGasto.className = `resumen-card ${presupuestado > 0 ? 'full-width' : ''}`;
                
                let colorGasto;
                switch(clasif) {
                    case 'GASTO': colorGasto = 'var(--color-gasto)'; break;
                    case 'TARJETA': colorGasto = 'var(--color-tarjeta)'; break;
                    case 'AHORRO': colorGasto = 'var(--color-ahorro)'; break;
                    default: colorGasto = 'var(--color-otro)';
                }
                
                let contenidoPresupuesto = '';
                if (presupuestado > 0) {
                    let porcentaje = (gastado / presupuestado) * 100;
                    let barraClass = 'progress-bar';
                    
                    if (porcentaje > 100) {
                        barraClass += ' over-budget';
                        porcentaje = 100; 
                    }

                    contenidoPresupuesto = `
                        <div class="card-presupuesto-texto">
                            <span class="monto-gastado">$${gastado.toLocaleString('es-AR')}</span> de 
                            <span class="monto-presupuesto">$${presupuestado.toLocaleString('es-AR')}</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="${barraClass}" style="width: ${porcentaje}%;"></div>
                        </div>
                    `;
                }

                cardGasto.innerHTML = `
                    <h3>${clasif}</h3>
                    <div class="card-monto" style="color: ${colorGasto};">
                        -$${gastado.toLocaleString('es-AR', {minimumFractionDigits: 2})}
                    </div>
                    ${contenidoPresupuesto}
                `;
                resumenTotalesDiv.appendChild(cardGasto);
            }
        }
        
        
        function renderizarGrafico() {
            if (miGraficoDeTorta) miGraficoDeTorta.destroy();
            
            const colores = obtenerColoresTema();

            const datosMes = getDatosMesActual();
            const sumasGastos = {};
            let totalGastos = 0;

            for (let t of datosMes) {
                if (t.clasificador !== 'INGRESO') {
                    if (!sumasGastos[t.clasificador]) sumasGastos[t.clasificador] = 0;
                    sumasGastos[t.clasificador] += t.monto;
                    totalGastos += t.monto;
                }
            }

            const ctx = graficoCanvas.getContext('2d');

            if (totalGastos === 0) {
                 ctx.clearRect(0, 0, graficoCanvas.width, graficoCanvas.height);
                 ctx.save();
                 ctx.fillStyle = colores.textoSecundario; 
                 ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'; 
                 ctx.textAlign = 'center';
                 ctx.fillText('No hay gastos para mostrar.', graficoCanvas.width / 2, graficoCanvas.height / 2);
                 ctx.restore();
                 return;
            }

            const labels = Object.keys(sumasGastos);
            const data = Object.values(sumasGastos);

            const backgroundColors = labels.map(label => obtenerColorClasificador(label, colores));

            miGraficoDeTorta = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: 'transparent', 
                        borderWidth: 0,              
                        hoverOffset: 8               
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribución de Gastos del Mes',
                            color: colores.textoPrincipal, 
                            font: {
                                size: 18,
                                weight: 'bold',
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        legend: {
                            position: 'bottom', 
                            labels: {
                                color: colores.textoSecundario, 
                                font: {
                                    size: 14,
                                    family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'
                                },
                                usePointStyle: true, 
                                padding: 20 
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = (value / totalGastos * 100).toFixed(1);
                                    return `${label}: $${value.toLocaleString('es-AR')} (${percentage}%)`;
                                }
                            },
                            backgroundColor: colores.fondoInput, 
                            titleColor: colores.textoPrincipal,      
                            bodyColor: colores.textoSecundario,       
                            borderColor: colores.borde,     
                            borderWidth: 1,
                            cornerRadius: 4,
                            padding: 10
                        }
                    }
                }
            });
        }
        
        // ! ===================================================
        // ! FUNCIÓN DE GRÁFICO (REESCRITA A BARRAS HORIZONTALES)
        // ! ===================================================
        function renderizarGraficoEvolucionDiaria() {
            if (miGraficoEvolucionDiaria) miGraficoEvolucionDiaria.destroy();

            // 1. Obtener colores del tema
            const colores = obtenerColoresTema();
            
            // 2. Calcular datos para el mes seleccionado
            const [anio, mes] = mesSeleccionado.split('-').map(Number);
            const diasEnElMes = new Date(anio, mes, 0).getDate();
            
            const labels = [];
            const datasetsData = new Map(); // Usamos un Map para construir los datasets
            
            // 3. Preparar etiquetas (Días del mes) y datasets
            for (let dia = 1; dia <= diasEnElMes; dia++) {
                labels.push(dia); // Etiquetas para el eje Y: 1, 2, 3...
            }
            
            // Inicializar datasets para todos los clasificadores
            for (const clasif of clasificadores) {
                datasetsData.set(clasif, {
                    label: clasif,
                    data: new Array(diasEnElMes).fill(0),
                    backgroundColor: obtenerColorClasificador(clasif, colores)
                });
            }
            
            // 4. Llenar los datos
            const transaccionesMes = getDatosMesActual();
            for (const t of transaccionesMes) {
                const dia = new Date(t.date + 'T12:00:00').getDate();
                const diaIndex = dia - 1; // Posición en el array
                
                // Asegurarse de que el dataset exista (por si se agregó un clasif nuevo y no está en 'clasificadores')
                if (!datasetsData.has(t.clasificador)) {
                    datasetsData.set(t.clasificador, {
                        label: t.clasificador,
                        data: new Array(diasEnElMes).fill(0),
                        backgroundColor: obtenerColorClasificador(t.clasificador, colores)
                    });
                }
                
                // Convertir gastos a negativos, ingresos a positivos
                const monto = t.clasificador === 'INGRESO' ? t.monto : -t.monto;
                datasetsData.get(t.clasificador).data[diaIndex] += monto;
            }

            // 5. Convertir el Map a un Array de datasets (solo los que tienen datos)
            const datasets = Array.from(datasetsData.values()).filter(d => 
                d.data.some(valor => valor !== 0) // Solo mostrar clasificadores con movimiento
            );

            // 6. Renderizar el gráfico de barras horizontal
            const ctx = evolucionDiariaCanvas.getContext('2d');
            miGraficoEvolucionDiaria = new Chart(ctx, {
                type: 'bar', // Tipo barra
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    indexAxis: 'y', // !NUEVO! Eje Y = Día, Eje X = Saldo
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Actividad Diaria por Categoría',
                            color: colores.textoPrincipal,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'bottom',
                            labels: { color: colores.textoSecundario }
                        },
                        tooltip: {
                            backgroundColor: colores.fondoInput,
                            titleColor: colores.textoPrincipal,
                            bodyColor: colores.textoSecundario,
                            borderColor: colores.borde,
                            borderWidth: 1,
                            cornerRadius: 4,
                            padding: 10,
                            callbacks: {
                                title: (context) => `Día ${context[0].label}`,
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const valor = context.parsed.x; // 'x' porque es horizontal
                                    return `${label}: $${valor.toLocaleString('es-AR')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { // Eje de Monto
                            stacked: true, // Apilar en el eje X
                            title: { display: true, text: 'Monto ($)', color: colores.textoSecundario },
                            ticks: { color: colores.textoSecundario },
                            grid: { color: colores.borde }
                        },
                        y: { // Eje de Días
                            stacked: true, // Apilar en el eje Y
                            title: { display: true, text: 'Día del Mes', color: colores.textoSecundario },
                            ticks: { color: colores.textoSecundario },
                            grid: { display: false } // Menos líneas
                        }
                    }
                }
            });
        }
        
        // FUNCIÓN DE GRÁFICO 6 MESES
        function renderizarGraficoEvolucion6Meses() {
            if (miGraficoEvolucion6Meses) miGraficoEvolucion6Meses.destroy();

            const colores = obtenerColoresTema();
            
            const labels = [];
            const datasetsData = {}; 
            const clasificadoresEnPeriodo = new Set(); 
            
            const hoy = new Date(); 

            for (let i = 5; i >= 0; i--) { 
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                const anio = fecha.getFullYear();
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const key = `${anio}-${mes}`;
                
                const label = `${NOMBRES_MESES[fecha.getMonth()]} '${anio.toString().slice(-2)}`;
                labels.push(label);

                const transaccionesMes = transacciones[key] || [];
                const sumasMes = {};
                
                for (const t of transaccionesMes) {
                    sumasMes[t.clasificador] = (sumasMes[t.clasificador] || 0) + t.monto;
                    clasificadoresEnPeriodo.add(t.clasificador); 
                }
                
                for (const clasif of clasificadores) { // Usamos todos los clasificadores
                    if (!datasetsData[clasif]) {
                        datasetsData[clasif] = new Array(5 - i).fill(0); 
                    }
                    datasetsData[clasif].push(sumasMes[clasif] || 0);
                }
            }
            
             for (const clasif of clasificadores) {
                 if(datasetsData[clasif]) {
                    while (datasetsData[clasif].length < 6) {
                        datasetsData[clasif].unshift(0);
                    }
                 }
             }

            const datasets = [];
            
            // Ordenar para que "INGRESO" salga primero
            const clasificadoresOrdenados = ['INGRESO', ...Array.from(clasificadores).filter(c => c !== 'INGRESO').sort()];

            for (const clasificador of clasificadoresOrdenados) {
                // Solo agregar si tuvo datos en el período
                if (clasificadoresEnPeriodo.has(clasificador)) {
                    const color = obtenerColorClasificador(clasificador, colores);
                    datasets.push({
                        label: clasificador,
                        data: datasetsData[clasificador],
                        borderColor: color,
                        backgroundColor: `${color}33`,
                        fill: 'start',
                        tension: 0.1
                    });
                }
            }

            const ctx = evolucion6MesesCanvas.getContext('2d');
            miGraficoEvolucion6Meses = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolución de Movimientos (Últimos 6 Meses)',
                            color: colores.textoPrincipal,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'bottom', 
                            labels: { color: colores.textoSecundario }
                        },
                        tooltip: {
                            backgroundColor: colores.fondoInput,
                            titleColor: colores.textoPrincipal,
                            bodyColor: colores.textoSecundario,
                            borderColor: colores.borde,
                            borderWidth: 1,
                            cornerRadius: 4,
                            padding: 10
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: colores.textoSecundario },
                            grid: { color: colores.borde }
                        },
                        y: {
                            ticks: { color: colores.textoSecundario },
                            grid: { color: colores.borde }
                        }
                    }
                }
            });
        }

        
        function renderizarCalendario() {
            calendarioContainer.innerHTML = '';
            const datosMes = getDatosMesActual();
            const datosPorDia = {};
            for (let t of datosMes) {
                const dia = new Date(t.date + 'T12:00:00').getDate();
                if (!datosPorDia[dia]) datosPorDia[dia] = new Set();
                datosPorDia[dia].add(t.clasificador);
            }
            const [anio, mes] = mesSeleccionado.split('-').map(Number);
            const primerDiaSemana = new Date(anio, mes - 1, 1).getDay();
            const diasEnMes = new Date(anio, mes, 0).getDate();
            for (let dia of DIAS_SEMANA) {
                const diaHeader = document.createElement('div');
                diaHeader.className = 'calendario-header';
                diaHeader.textContent = dia;
                calendarioContainer.appendChild(diaHeader);
            }
            for (let i = 0; i < primerDiaSemana; i++) {
                const diaVacio = document.createElement('div');
                diaVacio.className = 'calendario-dia otro-mes';
                calendarioContainer.appendChild(diaVacio);
            }
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const diaDiv = document.createElement('div');
                diaDiv.className = 'calendario-dia dia-valido';
                diaDiv.setAttribute('onclick', `mostrarModalDia(${dia})`);
                const numDiv = document.createElement('div');
                numDiv.className = 'dia-numero';
                numDiv.textContent = dia;
                diaDiv.appendChild(numDiv);
                if (datosPorDia[dia]) {
                    if (datosPorDia[dia].has('INGRESO')) {
                        const marcador = document.createElement('span');
                        marcador.className = 'dia-marcador-ingreso';
                        diaDiv.appendChild(marcador);
                    }
                    if ([...datosPorDia[dia]].some(c => c !== 'INGRESO')) {
                        const marcador = document.createElement('span');
                        marcador.className = 'dia-marcador-gasto';
                        diaDiv.appendChild(marcador);
                    }
                }
                calendarioContainer.appendChild(diaDiv);
            }
        }
        
        // --- FUNCIONES PARA EL MODAL ---
        function mostrarModalDia(dia) {
            const datosDia = getDatosMesActual().filter(t => {
                return new Date(t.date + 'T12:00:00').getDate() === dia;
            });
            const [anio, mes] = mesSeleccionado.split('-');
            const fechaTitulo = `${dia} de ${NOMBRES_MESES[mes-1]} de ${anio}`;
            modalTitulo.textContent = `Detalles del ${fechaTitulo}`;
            modalLista.innerHTML = ''; 
            if (datosDia.length === 0) {
                modalLista.innerHTML = '<li>No hay transacciones para este día.</li>';
            } else {
                for (let t of datosDia) {
                    const li = document.createElement('li');
                    let claseMonto = (t.clasificador === 'INGRESO') ? 'monto-ingreso' : 'monto-gasto';
                    let signo = (t.clasificador === 'INGRESO') ? '+' : '-';
                    li.innerHTML = `
                        <span>(${t.clasificador}) ${t.motivo}</span>
                        <span class="${claseMonto}">${signo} $${t.monto.toLocaleString('es-AR')}</span>
                    `;
                    modalLista.appendChild(li);
                }
            }
            modalContainer.style.display = 'flex';
        }
        
        function cerrarModal() {
            modalContainer.style.display = 'none';
        }
        
        // --- FUNCIONES DE EXPORTAR/IMPORTAR ---
        
        function exportarDatos() {
            console.log("Exportando datos...");
            
            const backupDatos = {
                transacciones: transacciones,
                presupuestos: presupuestos,
                clasificadores: Array.from(clasificadores) 
            };
            
            const dataStr = JSON.stringify(backupDatos, null, 2); 
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            
            const fechaHoy = new Date().toISOString().split('T')[0];
            a.download = `mis_finanzas_backup_${fechaHoy}.json`;
            
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert("Respaldo generado con éxito.");
            cerrarMenu(); // Cerramos el menú después de exportar
        }

        function importarDatos(event) {
            const file = event.target.files[0];
            if (!file) {
                return; 
            }
            
            if (!confirm("¿Importar respaldo? \n\n¡ATENCIÓN! Esto borrará TODOS los datos actuales que tengas en este dispositivo y los reemplazará con los datos del archivo. ¿Continuar?")) {
                event.target.value = null; 
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const data = JSON.parse(text);
                    
                    if (data.transacciones && data.presupuestos && data.clasificadores) {
                        
                        transacciones = data.transacciones;
                        presupuestos = data.presupuestos;
                        clasificadores = new Set(data.clasificadores);
                        
                        guardarDatosEnLocalStorage();
                        
                        alert("¡Datos importados con éxito! La aplicación se recargará.");
                        location.reload();
                        
                    } else {
                        alert("Error: El archivo no parece ser un respaldo válido.");
                    }
                } catch (error) {
                    console.error("Error al importar:", error);
                    alert("Error: No se pudo leer el archivo. Asegúrate de que sea el archivo .json correcto.");
                } finally {
                    event.target.value = null;
                }
            };
            
            reader.readAsText(file);
        }

    </script>
</body>
</html>
